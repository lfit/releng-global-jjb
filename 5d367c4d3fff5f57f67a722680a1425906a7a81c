{
  "comments": [
    {
      "key": {
        "uuid": "156e912c_1e9fe7d9",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 1,
      "author": {
        "id": 1
      },
      "writtenOn": "2019-09-09T19:46:13Z",
      "side": 1,
      "message": "Dropping the -l is likely not a good idea. IIRC we added that to work around certain issues that Jenkins has and the fact we need most shell scripts to run as if it\u0027s a logged in user.\n\nIt was added in I55947020e2f0cdbb61f9d4e7e88927d9bc304d17",
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4c1bc7dd_81de55e8",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 1,
      "author": {
        "id": 182
      },
      "writtenOn": "2019-09-09T22:05:41Z",
      "side": 1,
      "message": "I know it has been added all over the place. I talked with Thahn when he was debating how to handle/control the environment of these scripts. We talked about several approaches, none of which were perfect. The only approach I told him NOT to pursue was the -l. Seriously this would make Ken Thompson roll over in his grave. There is a reason that aliases, functions and shell variables are NOT passed on to children.\n\nThe environment is the part of a process that get inherited by it children (PATH, CWD, TERM) that are needed by sub-shells. Many/most of the files sourced by -l are specific to an interactive shell (they assume -ue is not set). Some of files sourced are owned by the user and it would be impossible to write a usable shell script that sourced user scripts. The only thing that should be calling bash -l is init. Bash is really two languages: a interactive process and a batch one. We want a child process to inherit what is needed from it parent, but to essential have a clean namespace.\n\nDo we know how many files get sourced when you add the \u0027-l\u0027? Bash pretty much works the same on all distros but the content of sourced files is VERY distro specific. They even change within each release of the distro. We want to remain isolated from that.  BTW on Ubuntu I couldn\u0027t run\u0027bash -eul\u0027 because of the \u0027-u\u0027. The only reason the \u0027-l\u0027 works as well as it does for us is because this script is only run by one user, If this script were used  by multiple users it would be a disaster. BTW people do run some scripts in a VM (The HL developers do it all the time).\n\nYou are correct Jenkins has really made a mess of controlling the environment of the scripts. Both the previous times I used Jenkins as a scheduler, we isolated ourselves from what Jenkins was trying to do. Jenkins called ONE script that controlled the entire build. BTW the first line of the top level script overrode PATH\u003da:b:c \n\nIf there is some environment (functions alias variables) that need to be shared by multiple scripts then we source a file (that WE control). It is a essentially a bash \u0027library\u0027 that is specific to batch scripts. In HL I created a file ~/.lfenv that contains some functions/aliases that are shared across multiple scripts.\n\nI very well may be missing something here, but at the time Thanh was unable to articulate what that was. Adding the -l does not really change the environment of a script it really only effects the shell environment from the login scripts (called by -l) which are meant for interactive shell, not a batch script. The true environment (ENV vars comes from the login shell that is a parent (possible about 10 levels up, and probably mangled by Jenkins).",
      "parentUuid": "156e912c_1e9fe7d9",
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "34cd224d_90f9ba30",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 1,
      "author": {
        "id": 8
      },
      "writtenOn": "2019-09-09T23:07:54Z",
      "side": 1,
      "message": "The `-l` is necessary for Jenkins shell to add `~/.local/bin` to the path which we depend on because of our use of `pip install --user` to install Python based CLI tools such as lftools and openstack. Without this we would need to add `~/.local/bin` to every single file that wants to use `lftools` and `openstack`, but that\u0027s just a birds eye view from global-jjb\u0027s perspective, downstream project might depend further on additional CLI tools that they are installing in their own projects as well.\n\nIn isolation in the context of just this one script this seems fine. This change might break if applied to other scripts so we should definitely test and confirm before blanket removing `-l` in all scripts. One reason I would keep `-l` is for consistency, folks tend to copy/paste scripts from existing scripts to build upon their own scripts, having varing uses means folks might copy from the wrong scripts and we would have to support multiple methods.\n\nOne of the reasons we went with `-l` is it\u0027s a lot easier to tell all our consumers of global-jjb that they need to `#!/bin/bash -l` in their scripts than to tell them to ` PATH\u003d\"$PATH:~/.local/bin\" ` in every single shell script.\n\nWith that said I\u0027m far from the authority on this so if we want to change how we recommend our downstreams consume global-jjb I would recommend detailed documentation of the recommended path and communicating it to the communities so that folks are not surprised if something breaks somewhere.",
      "parentUuid": "4c1bc7dd_81de55e8",
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "12240d4c_9af0ef6b",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 1,
      "author": {
        "id": 182
      },
      "writtenOn": "2019-09-10T00:39:21Z",
      "side": 1,
      "message": "Actually customers don\u0027t have to add add ~/.local/bin their PATH. If lftools is properly implemented they could just call it directly: \u0027~/.local/bin/lftools deploy .......\u0027 We just have to tell them that \u0027lftools\u0027 is installed in ~/.local/bin how they execute is their choice. This is Unix and that is how should works.\n\nIf we steer customers away from standard Unix practices we are asking for trouble... There is always 10 ways to do things in Unix, but some of them are possible but just plain wrong.",
      "parentUuid": "34cd224d_90f9ba30",
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bc56d5f6_9da602fb",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 1,
      "author": {
        "id": 29
      },
      "writtenOn": "2019-09-10T06:20:04Z",
      "side": 1,
      "message": "Using `-l` may have its side effects, since this ends of reading /etc/profile and scripts which a normal user should not require.\n\nHowever, this is something that we have discussed in the past and found it\u0027s not harmful setting this a temp minion nodes, since upstream images are used on the cloud.",
      "parentUuid": "12240d4c_9af0ef6b",
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3f27b270_bd1a493f",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 1,
      "author": {
        "id": 12
      },
      "writtenOn": "2019-09-10T14:09:03Z",
      "side": 1,
      "message": "#!/bin/bash is already a work-around since jenkins defaults to sh\n\nbetween \" #!/bin/bash -l \" or \" #!/bin/bash; PATH\u003d\"$PATH:~/.local/bin\" \"\n\n#!/bin/bash -l is our conventional work around, we are using it everywhere.\n\n*fixing* it here, where it _could_ be swapped out, leads us to swapping it everywhere, which means revisiting this workaround in untold number of places. \nThe login shell has afaik yet to fail us, I don\u0027t really see the benefit in changing it in one place.",
      "parentUuid": "bc56d5f6_9da602fb",
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b990dd54_0c03e308",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 12
      },
      "writtenOn": "2019-09-10T14:09:03Z",
      "side": 1,
      "message": "Why are you setting noglob?, please explain.",
      "range": {
        "startLine": 13,
        "startChar": 20,
        "endLine": 13,
        "endChar": 29
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a833c845_46075d20",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 16,
      "author": {
        "id": 12
      },
      "writtenOn": "2019-09-09T20:35:07Z",
      "side": 1,
      "message": "is this to work around your removal of -l?\nI would prefer to keep the -l as well.",
      "range": {
        "startLine": 16,
        "startChar": 0,
        "endLine": 16,
        "endChar": 22
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bb0e5dc8_c7cfdaf7",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 16,
      "author": {
        "id": 182
      },
      "writtenOn": "2019-09-09T22:05:41Z",
      "side": 1,
      "message": "Why source 100\u0027s of lines of unknown lines of scripts (that changes for every distro) just to modify the PATH? In fact, since we only call lftools twice I would make the case that we should just execute it directly (~/.local/bin/lftools) and not even add it to the PATH. Although I bet lftools expects PATH to be set (which is NOT correct), if lftools needs something in its path it should add it.",
      "parentUuid": "a833c845_46075d20",
      "range": {
        "startLine": 16,
        "startChar": 0,
        "endLine": 16,
        "endChar": 22
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "03699b6f_f8c6919d",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 28,
      "author": {
        "id": 29
      },
      "writtenOn": "2019-09-10T06:20:04Z",
      "side": 1,
      "message": "handle debian?",
      "range": {
        "startLine": 28,
        "startChar": 8,
        "endLine": 28,
        "endChar": 14
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "84fdb180_e40c8139",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 31,
      "author": {
        "id": 29
      },
      "writtenOn": "2019-09-10T06:20:04Z",
      "side": 1,
      "message": "So if we are running this script in Suse, the script would simply exit here, the Jenkins jobs would skip the deploy logs/archive to Nexus. Needs to handle default cause correctly.",
      "range": {
        "startLine": 31,
        "startChar": 12,
        "endLine": 31,
        "endChar": 16
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2c80f41f_b78cadfd",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 42,
      "author": {
        "id": 29
      },
      "writtenOn": "2019-09-10T06:20:04Z",
      "side": 1,
      "message": "Its useful to capture the system logs here, but this looks sneaky here, since this script\u0027s function is to simply deploy log/archives to Nexus. \n\nI\u0027d write a separate JJB macro/shell script, similar to what is being done for system stats.",
      "range": {
        "startLine": 23,
        "startChar": 0,
        "endLine": 42,
        "endChar": 6
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a607ba57_0f3f6dbd",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 49,
      "author": {
        "id": 12
      },
      "writtenOn": "2019-09-10T14:09:03Z",
      "side": 1,
      "message": "deploy.py states that it takes \":pattern: Space-separated list of Globstar patterns of files to\narchive. (optional) \"\n\nI see in the code that passing multiple -p values is allowed (multiple true) But does this actually work? if it does, the output from help in lftools on the matter is not clear.",
      "range": {
        "startLine": 47,
        "startChar": 0,
        "endLine": 49,
        "endChar": 8
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1f12e51e_c04a40bf",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 54,
      "author": {
        "id": 1
      },
      "writtenOn": "2019-09-09T19:46:13Z",
      "side": 1,
      "message": "Is there a reason you\u0027re dropping the null case handler if the $BUILD_URL isn\u0027t set?",
      "range": {
        "startLine": 54,
        "startChar": 47,
        "endLine": 54,
        "endChar": 57
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e4ff2427_54a6b7dc",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 54,
      "author": {
        "id": 182
      },
      "writtenOn": "2019-09-09T22:05:41Z",
      "side": 1,
      "message": "This is a good question.... what happens if an empty string is passed to lftools?  A URL of \"\" make no sense. Now it lftools documented that it does something useful with the \"\" then I am all for it. If BUILD_URL is not set, the script (and the build) stops right here.\n\nSo the answer is I don\u0027t know it this should be quoted or not. The quotes are probably there just to make sure \u0027shellcheck\u0027 does not whine. I am assuming that \"\" not a valid URL for lftools rather than hope that lftools does something reasonable.",
      "parentUuid": "1f12e51e_c04a40bf",
      "range": {
        "startLine": 54,
        "startChar": 47,
        "endLine": 54,
        "endChar": 57
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dba2dd1b_6fcd457c",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 54,
      "author": {
        "id": 8
      },
      "writtenOn": "2019-09-09T23:07:54Z",
      "side": 1,
      "message": "As long as the script is run inside Jenkins BUILD_URL can be assumed to exist. What I\u0027d be surprised about is that the `set -u` above is not causing this line to fail due to the -u check (Did you test this script in an actual job?).",
      "parentUuid": "e4ff2427_54a6b7dc",
      "range": {
        "startLine": 54,
        "startChar": 47,
        "endLine": 54,
        "endChar": 57
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "461e8dc3_ab9dcf2c",
        "filename": "shell/logs-deploy.sh",
        "patchSetId": 1
      },
      "lineNbr": 54,
      "author": {
        "id": 182
      },
      "writtenOn": "2019-09-10T00:39:21Z",
      "side": 1,
      "message": "If BUILD_URL is supposed to be set then we want the script to error when it is not.\nshellcheck is not a runtime check and since BUILD_URL is upper-case it will not check if it has already been set in the script. The \u0027-u\u0027 is a runtime check so it will trigger an error at runtime if it is unset. Hopefully lftools would error out if BUILD_URL\u003d\"\", but I don\u0027t want to find out.\n\nIf BUILD_URL is unset then $BUILD_URL should cause an error in lftools (missing argument) and \"$BUILD_URL\" will pass \"\"  as the last argument to lftools. That is why we shouldn\u0027t quote \u0027pattern_opts\u0027 on the previous line.",
      "parentUuid": "dba2dd1b_6fcd457c",
      "range": {
        "startLine": 54,
        "startChar": 47,
        "endLine": 54,
        "endChar": 57
      },
      "revId": "5d367c4d3fff5f57f67a722680a1425906a7a81c",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    }
  ]
}