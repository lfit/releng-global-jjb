{
  "comments": [
    {
      "key": {
        "uuid": "d57d597c_4a5228c8",
        "filename": "shell/capture-instance-metadata.sh",
        "patchSetId": 2
      },
      "lineNbr": 16,
      "author": {
        "id": 1
      },
      "writtenOn": "2020-08-05T16:12:08Z",
      "side": 1,
      "message": "While this script isn\u0027t currently being called by anything we need to do a little proactive safety measure to make sure that it\u0027s running in a system that has the metadata service available.\n\nAt present we have builders running Openstack (supported by us), EC2 (supported by us), and Nomad (supported Jenkins, but \"unsupported\" build instances).\n\nBoth Openstack and EC2 have the metadata service available but from all my research Nomad does not.\n\nSo, first things first, we should only be running this IFF $NOMAD_DC is not defined (it\u0027s one of several Nomad specific ENV vars). This means wrapping the entire operation in an \u0027if [ -z \"${NOMAD_DC}\" ]\u0027 will resolve that.\n\nSecondly, we need to handle getting back a 404 from the service because EC2 is not going to service the /openstack/ URI fragment. Unfortunately it doesn\u0027t look like there\u0027s a way to just grab all the EC2 metadata so for now, I\u0027m going to suggest we just skip dealing with it until such time as we find that having any of that data would be useful for troubleshooting EC2 instances.",
      "revId": "0fd9d85a5b8e1cd635b341917405a3fbc568897e",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "412717a9_4992f7d9",
        "filename": "shell/capture-instance-metadata.sh",
        "patchSetId": 2
      },
      "lineNbr": 16,
      "author": {
        "id": 1
      },
      "writtenOn": "2020-08-05T16:17:20Z",
      "side": 1,
      "message": "To follow onto my last comment, instead of trying to handle a 404 we can just detect if we\u0027re in EC2 by lifting a check out of the job-cost shell script.\n\nSo, the fixes would be the following:\n\n--[cut]--\nif [ -z \"${NOMAD_DC}\" ] ; then\n  echo \"INFO: Running in Nomad, no metadata\"\n  exit 0\nfi\n\nif grep -qi amazon /sys/devices/virtual/dmi/id/bios_vendor ; then\n  echo \"INFO: Running in AWS, not capturing instance metadata\"\n  exit 0\nfi\n--[/cut]--\n\nThen the rest of the script could be left as is if that is put before it.",
      "parentUuid": "d57d597c_4a5228c8",
      "revId": "0fd9d85a5b8e1cd635b341917405a3fbc568897e",
      "serverId": "f2a2391d-0403-4fa5-b183-4056999a8a09",
      "unresolved": true
    }
  ]
}